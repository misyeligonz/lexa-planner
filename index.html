<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f3d6e">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <title>Lexa Planner — Deep Blue · Soft Gray</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --deep-blue:#0f3d6e; --deep-blue-600:#134a88; --soft-gray:#f4f6f8;
      --ink:#1d2430; --muted:#6b7280; --card:#ffffff; --border:#d5dbe3;
      --danger:#d9685b; --radius:18px;
      --shadow:0 8px 24px rgba(15,61,110,.08), 0 2px 6px rgba(15,61,110,.05);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans";
      color:var(--ink);background:linear-gradient(180deg,var(--soft-gray),#fff 60%)}
    .app{max-width:960px;margin:0 auto;padding:24px; padding-bottom:120px;}
    header{display:flex;align-items:center;gap:14px;margin-bottom:12px;padding:12px 0 4px}
    .logo{width:40px;height:40px;border-radius:12px;background:radial-gradient(100% 100% at 30% 20%, #7fc1ff 0, #4f9fe0 40%, var(--deep-blue) 100%);box-shadow:inset 0 0 0 2px rgba(255,255,255,.25)}
    h1{font-size:20px;margin:0;letter-spacing:.3px}
    .subtitle{color:var(--muted);font-size:13px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .toolbar-top{display:flex;justify-content:space-between;align-items:center;padding:10px 12px}
    .btn{appearance:none;border:none;border-radius:14px;padding:10px 14px;font-weight:600;letter-spacing:.2px;cursor:pointer;background:var(--deep-blue);color:#fff;box-shadow:0 2px 0 rgba(0,0,0,.06)}
    .btn.secondary{background:#eef3f8;color:var(--deep-blue);border:1px solid var(--border)}
    .btn.ghost{background:transparent;color:var(--deep-blue);border:1px dashed var(--border)}
    .btn:active{transform:translateY(1px)}
    .input-area{padding:12px}
    textarea{width:100%;min-height:160px;resize:vertical;border-radius:14px;border:1px solid var(--border);padding:14px;background:#fbfcfe;outline:none;box-shadow:inset 0 1px 0 #fff;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    textarea::placeholder{color:#9aa6b2}
    .timeline{position:relative;padding:18px 10px}
    .timeline:before{content:"";position:absolute;left:44px;top:0;bottom:0;width:2px;background:linear-gradient(var(--border),#cfd6df)}
    .card{position:relative;display:grid;grid-template-columns:110px 1fr;gap:12px;padding:12px;margin:8px 0 14px;background:var(--card);border:1px solid var(--border);border-left:6px solid var(--deep-blue);border-radius:14px;box-shadow:var(--shadow)}
    .card.done{opacity:.6} .card .title.done{text-decoration:line-through}
    .time{font-weight:700;color:var(--deep-blue-600);font-family:'JetBrains Mono','Roboto Mono','Courier New',monospace;font-variant-numeric:tabular-nums;font-feature-settings:"tnum" 1,"zero" 1;letter-spacing:.2px}
    .title{font-weight:700;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .meta{color:var(--muted);font-size:13px;margin-top:4px}
    .dot{position:absolute;left:41px;top:18px;width:12px;height:12px;background:#fff;border:2px solid var(--deep-blue);border-radius:50%}
    .actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
    .action{font-size:12px;padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:#f8fbff;color:#0f3d6e;cursor:pointer}
    .action:active{transform:translateY(1px)}
    .subtasks{margin:8px 0 0;padding:0;list-style:none}
    .subtasks li{display:flex;align-items:flex-start;gap:8px;margin:4px 0}
    .subtasks input[type="checkbox"]{margin-top:2px}
    .subtasks .st-done{text-decoration:line-through;color:var(--muted)}

    /* Bottom toolbar */
    .toolbar-bottom{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--border);box-shadow:0 -6px 24px rgba(15,61,110,.05);padding:8px 12px}
    .toolbar-bottom .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
    .toolbar-bottom .row2{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
    .date-input{border:1px solid var(--border);border-radius:12px;padding:8px 10px;background:#fbfcfe}
    @media print{.toolbar-top,.toolbar-bottom,.input-area,textarea,.actions{display:none!important}body{background:#fff}.app{max-width:800px}.panel{box-shadow:none}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Lexa Planner</h1>
        <div class="subtitle">Deep Blue · Soft Gray — v3.1.2</div>
      </div>
    </header>

    <div class="grid">
      <!-- Top panel (Copy/PDF + summary) -->
      <section class="panel">
        <div class="toolbar-top">
          <div style="font-weight:700; color:var(--deep-blue-600)">Today</div>
          <div style="display:flex; gap:8px; align-items:center">
            <button class="btn secondary" id="copyBtn">Copy</button>
            <button class="btn secondary" id="pdfBtn">PDF</button>
            <div id="summary" class="meta"></div>
          </div>
        </div>
        <div id="timeline" class="timeline">
          <div class="empty">Your planner will appear here.</div>
        </div>
      </section>

      <!-- Input panel -->
      <section class="panel">
        <div class="input-area">
          <textarea id="raw" placeholder="Paste time blocks, one per line.
Use semicolons “;” for subtasks, e.g.
09:30–10:15 Warm-up Admin — 1 invoice; demand letter; skim inbox
Optional: [Category], @location at end, #tags anywhere."></textarea>
          <div class="subtitle" style="padding:8px 12px 14px">Tip: You can mix 12-hour or 24-hour times, and use -, –, —, or “to”.</div>
        </div>
      </section>
    </div>
  </div>

  <!-- Bottom toolbar -->
  <div class="toolbar-bottom">
    <div class="row">
      <button class="btn" id="renderBtn">Render</button>
      <button class="btn secondary" id="sampleBtn">Sample</button>
      <button class="btn ghost" id="clearBtn">Clear</button>
      <button class="btn secondary" id="saveBtn">Save</button>
      <button class="btn secondary" id="loadYBtn">Load Yesterday</button>
    </div>
    <div class="row2">
      <input type="date" id="datePicker" class="date-input">
      <button class="btn secondary" id="todayBtn">Today</button>
    </div>
  </div>

  <script>
  (function (){
    // --------- Helpers (dates / storage) ----------
    const $ = (id)=>document.getElementById(id);
    const STORAGE_PREFIX = 'lexa:plan:';
    function toISODate(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
    function todayKey(){ return toISODate(new Date()); }
    function addDays(iso, delta){ const d=new Date(iso); d.setDate(d.getDate()+delta); return toISODate(d); }

    function kRaw(iso){   return `${STORAGE_PREFIX}${iso}:raw`; }
    function kChecks(iso){return `${STORAGE_PREFIX}${iso}:checks`; }

    function saveRawText(iso, t){ localStorage.setItem(kRaw(iso), t); }
    function loadRawText(iso){  return localStorage.getItem(kRaw(iso)) || ''; }

    function saveChecksMap(iso, map){ localStorage.setItem(kChecks(iso), JSON.stringify(map)); }
    function loadChecksMap(iso){ try { return JSON.parse(localStorage.getItem(kChecks(iso))||'{}'); } catch { return {}; } }

    // --------- State ----------
    let items = [];
    let originalLines = [];
    let selectedISO = todayKey();
    let checksMap = loadChecksMap(selectedISO);

    // --------- Time & parsing ----------
    function toMin(h, m, ap){
      let hh = parseInt(h||'0',10), mm = parseInt(m||'0',10);
      const p = (ap||'').toLowerCase();
      if (p==='pm' && hh!==12) hh+=12;
      if (p==='am' && hh===12) hh=0;
      return hh*60+mm;
    }
    function fmt(min){
      const h = Math.floor(min/60), m = min % 60;
      const ap = h >= 12 ? 'PM' : 'AM';
      const hr12 = ((h % 24) % 12) || 12;
      return `${String(hr12).padStart(2,'0')}:${String(m).padStart(2,'0')} ${ap}`;
    }
    function pad24(min){
      const h = Math.floor(min/60), m = min % 60;
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    }
    function serializeItem(it){
      const left = `${pad24(it.start)}-${pad24(it.end)}`;
      const parts = [it.title];
      if (it.category) parts.push(`[${it.category}]`);
      if (it.location) parts.push(`@${it.location}`);
      if (it.tags?.length) parts.push(it.tags.map(t=>`#${t}`).join(' '));
      return `${left} ${parts.filter(Boolean).join(' ')}`.trim();
    }
    function parseLine(line){
      if(!line) return null;
      let s = line.replace(/\u00A0/g,' ').trim();
      s = s.replace(/[—–−]/g,'-').replace(/\s+to\s+/i,'-').replace(/\s*-\s*-\s*/g,'-').trim();
      s = s.replace(/^(\d{1,2}(?::\d{2})?\s*(?:am|pm)?)\s*-\s*(\d{1,2}(?::\d{2})?\s*(?:am|pm)?)\s*-?\s+/i,'$1-$2 ');
      const re = /^\s*(\d{1,2})(?::(\d{2}))?\s*(am|pm)?\s*-\s*(\d{1,2})(?::(\d{2}))?\s*(am|pm)?\s+(.+?)\s*$/i;
      const m = s.match(re);
      if(!m) return null;
      const [,h1,mi1,ap1,h2,mi2,ap2,rest] = m;
      const start = toMin(h1, mi1, ap1||'');
      const end   = toMin(h2, mi2, ap2||'');

      let title = rest.trim();
      let category=null, tags=[], location=null;
      const cat = title.match(/\[(.+?)\]/);
      if(cat){ category=cat[1].trim(); title=title.replace(cat[0],'').trim(); }
      title = title.replace(/#(\S+)/g, (_,$1)=>{ tags.push($1); return ''; }).trim();
      const loc = title.match(/@(\S[\w\s\-.,/()]*)$/);
      if(loc){ location=loc[1].trim(); title=title.replace(loc[0],'').trim(); }

      // Subtasks via semicolons
      let mainTitle = title, subtasks = [];
      const dashSplit = title.split(/\s-\s/);
      if (dashSplit.length > 1 && dashSplit.slice(1).join(' - ').includes(';')) {
        mainTitle = dashSplit[0].trim();
        const after = dashSplit.slice(1).join(' - ').trim();
        subtasks = after.split(';').map(t=>t.trim()).filter(Boolean);
      } else if (title.includes(';')) {
        const parts = title.split(';').map(t=>t.trim()).filter(Boolean);
        mainTitle = parts.shift() || title;
        subtasks = parts;
      }
      return { start, end, title: mainTitle, subtasks, category, tags, location };
    }
    function escapeHtml(str){ return str.replace(/[&<>\"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }

    // --------- Render ----------
    function render(lines){
      originalLines = lines.slice();
      items = [];
      lines.forEach((raw, i)=>{
        const t = (raw||'').trim(); if(!t) return;
        const it = parseLine(t);
        if(it){ it.lineIndex = i; items.push(it); }
      });
      items.sort((a,b)=>a.start-b.start);

      const host = $('timeline'); host.innerHTML='';
      if(!items.length){
        host.innerHTML='<div class="empty">Nothing to show. Paste time blocks and tap <b>Render</b>.</div>';
        $('summary').textContent=''; return;
      }
      const total=items.reduce((s,i)=>s+(i.end-i.start),0);
      $('summary').textContent = `${items.length} block${items.length>1?'s':''} · ${Math.floor(total/60)}h ${total%60}m`;

      const stored = loadChecksMap(selectedISO);
      items.forEach((it, idx)=>{
        const card = document.createElement('div'); card.className='card'; card.dataset.index=idx;
        const meta = [it.category?`[${escapeHtml(it.category)}]`:null, it.location?`@ ${escapeHtml(it.location)}`:null, it.tags.length?`#${it.tags.join(' #')}`:null].filter(Boolean).join(' · ');

        const lineStore = stored[it.lineIndex] || {}; const subChecks = lineStore.sub || {};
        let subtasksHtml='';
        if(it.subtasks && it.subtasks.length){
          const list = it.subtasks.map((st, si)=>{
            const checked=!!subChecks[si];
            return `<li><input type="checkbox" class="subtask" data-si="${si}" ${checked?'checked':''}><span class="st-label ${checked?'st-done':''}">${escapeHtml(st)}</span></li>`;
          }).join('');
          subtasksHtml = `<ul class="subtasks">${list}</ul>`;
        }

        card.innerHTML = `
          <span class="dot" aria-hidden="true"></span>
          <div class="time">${fmt(it.start)}–${fmt(it.end)}</div>
          <div>
            <div class="title">${escapeHtml(it.title)}</div>
            <div class="meta">${meta}</div>
            ${subtasksHtml}
            <div class="actions">
              <button class="action" data-act="done">✅ Done</button>
              <button class="action" data-act="move">⏭ Move</button>
              <button class="action" data-act="remind">⏰ Remind</button>
            </div>
          </div>`;
        if(it.subtasks?.length){
          const all = it.subtasks.every((_,si)=>!!subChecks[si]);
          if(all){ card.classList.add('done'); card.querySelector('.title').classList.add('done'); }
        } else if(lineStore.done){ card.classList.add('done'); card.querySelector('.title').classList.add('done'); }
        host.appendChild(card);
      });
    }

    // --------- Bind after window load ----------
    window.addEventListener('load', () => {
      // Subtask toggles
      document.addEventListener('change', (e)=>{
        const box = e.target.closest('input.subtask'); if(!box) return;
        const card = box.closest('.card'); const idx = +card.dataset.index; const it = items[idx];
        const si = +box.dataset.si;
        const label = box.nextElementSibling; if(label) label.classList.toggle('st-done', box.checked);

        checksMap[it.lineIndex] = checksMap[it.lineIndex] || { sub: {} };
        checksMap[it.lineIndex].sub = checksMap[it.lineIndex].sub || {};
        checksMap[it.lineIndex].sub[si] = box.checked;

        const all = [...card.querySelectorAll('input.subtask')].every(b=>b.checked);
        card.classList.toggle('done', all);
        card.querySelector('.title').classList.toggle('done', all);
        if(!it.subtasks?.length){ checksMap[it.lineIndex].done = all; }
        saveChecksMap(selectedISO, checksMap);
      });

      // Card actions
      document.addEventListener('click', async (e)=>{
        const btn = e.target.closest('.action'); if(!btn) return;
        const card = btn.closest('.card'); const idx = +card.dataset.index; const it = items[idx];
        if(btn.dataset.act==='done'){
          const boxes = card.querySelectorAll('input.subtask');
          if(boxes.length){
            const anyUnchecked = [...boxes].some(b=>!b.checked);
            boxes.forEach((b,si)=>{
              b.checked = anyUnchecked;
              const lbl = b.nextElementSibling; if(lbl) lbl.classList.toggle('st-done', anyUnchecked);
              checksMap[it.lineIndex] = checksMap[it.lineIndex] || { sub: {} };
              checksMap[it.lineIndex].sub = checksMap[it.lineIndex].sub || {};
              checksMap[it.lineIndex].sub[si] = anyUnchecked;
            });
            card.classList.toggle('done', anyUnchecked);
            card.querySelector('.title').classList.toggle('done', anyUnchecked);
          } else {
            const willBe = !card.classList.contains('done');
            card.classList.toggle('done', willBe);
            card.querySelector('.title').classList.toggle('done', willBe);
            checksMap[it.lineIndex] = checksMap[it.lineIndex] || {};
            checksMap[it.lineIndex].done = willBe;
          }
          saveChecksMap(selectedISO, checksMap);
          return;
        }
        if(btn.dataset.act==='move'){
          const input = prompt("New time range (e.g., 6:30-7:00 PM or 18:30-19:00):","");
          if(!input) return;
          const m = input.replace(/[—–]/g,'-').match(/(\d{1,2}(?::\d{2})?\s*(?:am|pm)?)\s*[^0-9]+\s*(\d{1,2}(?::\d{2})?\s*(?:am|pm)?)/i);
          if(!m) return alert("Try formats like '6:30-7:00 PM' or '18:30-19:00'.");
          const parseAny = (s)=>{ const p=s.trim().match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/i); if(!p) return null; return toMin(p[1], p[2]||'00', p[3]||''); };
          const sMin = parseAny(m[1]), eMin = parseAny(m[2]);
          if(sMin==null || eMin==null) return alert("Invalid time.");
          it.start = sMin; it.end = eMin;

          // write back to textarea + save
          const lineIdx = it.lineIndex;
          if(lineIdx!=null && lineIdx>=0){
            originalLines[lineIdx] = serializeItem(it);
            $('raw').value = originalLines.join('\n');
            saveRawText(selectedISO, $('raw').value);
          }
          render(originalLines);
          return;
        }
        if(btn.dataset.act==='remind'){
          const offsetStr = prompt("Remind how many minutes before start?","10");
          const offsetMin = Math.max(0, parseInt(offsetStr||"0",10));
          if(!('Notification' in window)) return alert('Notifications not supported.');
          const perm = await Notification.requestPermission();
          if(perm!=='granted') return alert('Notification permission was denied.');
          const now = new Date();
          const when = new Date(now.getFullYear(), now.getMonth(), now.getDate(), Math.floor(it.start/60), it.start%60).getTime() - offsetMin*60000;
          const delay = Math.max(0, when - Date.now());
          setTimeout(()=> new Notification('Lexa Reminder', { body: `${fmt(it.start)} — ${it.title}` }), delay);
          alert('Reminder set.');
        }
      });

      // Bottom toolbar
      $('renderBtn').addEventListener('click', ()=>{
        const raw = $('raw').value;
        saveRawText(selectedISO, raw);
        render(raw.split(/\n+/));
        $('timeline').scrollIntoView({behavior:'smooth',block:'start'});
      });
      $('sampleBtn').addEventListener('click', ()=>{
        $('raw').value = `08:30-09:15 Client conf. [Litigation] @RTC Branch 53 #prep
9:30–10:00 Team standup [Personal]
10:15 to 11:45 Draft MR citing RA 8974 [Litigation] #urgent
12:00-13:00 Lunch w/ Alan [Personal] @Ayala Mall
14:00—14:40 Review invoices [Billing]
15:00-16:00 Estate mtg re TCTs [Estate] @GRDC`;
      });
      $('clearBtn').addEventListener('click', ()=>{
        $('raw').value=''; $('timeline').innerHTML='<div class="empty">Your planner will appear here.</div>'; $('summary').textContent='';
        checksMap = {};
        localStorage.removeItem(kRaw(selectedISO));
        localStorage.removeItem(kChecks(selectedISO));
        $('raw').focus();
      });
      $('saveBtn').addEventListener('click', ()=>{ saveRawText(selectedISO, $('raw').value); alert('Saved.'); });
      $('loadYBtn').addEventListener('click', ()=>{
        const yISO = addDays(selectedISO, -1);
        const yRaw = loadRawText(yISO);
        if(!yRaw){ alert('No plan saved for yesterday.'); return; }
        $('raw').value = yRaw;
        render(yRaw.split(/\n+/));
      });

      // Date picker + Today
      const dp = $('datePicker');
      function setDate(iso){
        selectedISO = iso;
        dp.value = iso;
        checksMap = loadChecksMap(selectedISO);
        const raw = loadRawText(selectedISO);
        $('raw').value = raw;
        if(raw) render(raw.split(/\n+/));
        else { $('timeline').innerHTML='<div class="empty">No saved plan for this date. Paste blocks and Render.'; $('summary').textContent=''; }
      }
      dp.addEventListener('change', ()=>{ if(dp.value) setDate(dp.value); });
      $('todayBtn').addEventListener('click', ()=> setDate(todayKey()));

      // Init today
      setDate(todayKey());

      // Copy/PDF
      $('copyBtn').addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText($('timeline').innerText||''); alert('Copied to clipboard.'); }
        catch{ alert('Copy failed.'); }
      });
      $('pdfBtn').addEventListener('click', ()=>window.print());

      // SW
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
      }
    });
  })();
  </script>
</body>
</html>
